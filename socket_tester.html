<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DGT Centaur Socket Tester</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
      integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"
      crossorigin="anonymous"
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 10px;
        box-sizing: border-box;
        background-color: #f8f9fa;
      }
      body {
        font-family: Arial, sans-serif;
        display: flex;
        gap: 20px;
      }
      .column {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .main-controls {
        width: 400px;
        flex-shrink: 0;
      }
      .actions-column {
        width: 400px;
        flex-shrink: 0;
      }
      .log-column {
        flex-grow: 1;
        height: calc(
          100vh - 20px
        ); /* Full viewport height minus body padding */
      }
      #board {
        width: 400px;
      }
      #log {
        width: 100%;
        flex-grow: 1;
        border: 1px solid #ccc;
        padding: 5px;
        overflow-y: scroll;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
        box-sizing: border-box;
      }
      #status {
        font-weight: bold;
      }
      .action-group,
      .connection-group,
      .engine-evaluation {
        display: flex;
        flex-direction: column;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        gap: 8px;
        background-color: #fff;
      }
      .connection-group div {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      select,
      button,
      input,
      textarea {
        padding: 8px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
      }
      .eval-bar-container {
        width: 100%;
        height: 20px;
        background-color: #404040;
        border-radius: 3px;
        overflow: hidden;
      }
      .eval-bar {
        height: 100%;
        width: 50%;
        background-color: #f0f0f0;
        transition: width 0.5s ease;
      }
      #eval-score {
        margin-top: 5px;
        font-weight: bold;
        text-align: center;
      }
      #top-moves {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
        font-family: monospace;
        font-size: 13px;
        white-space: pre;
        line-height: 1.4;
      }
      .advanced-actions button {
        background-color: #e7f3ff;
        border: 1px solid #007bff;
        color: #007bff;
      }
      h2,
      h3 {
        margin-top: 0;
        margin-bottom: 5px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div class="column main-controls">
      <h2>DGT Centaur Socket Tester</h2>
      <div class="connection-group">
        <div>
          <label for="ip-input">Centaur IP:</label>
          <input type="text" id="ip-input" value="192.168.0.171" />
          <button id="connect-button">Connect</button>
        </div>
        <div id="status">Status: Disconnected</div>
      </div>
      <div id="board"></div>
      <p>Drag pieces to send a `web_move` event.</p>
      <div class="engine-evaluation">
        <h3>Stockfish Evaluation</h3>
        <div class="eval-bar-container">
          <div id="eval-bar" class="eval-bar"></div>
        </div>
        <div id="eval-score">Score: 0.00</div>
        <div id="top-moves"></div>
      </div>
    </div>

    <div class="column actions-column">
      <div class="action-group">
        <h3>Manual Event</h3>
        <label for="channel-input">Channel:</label>
        <input
          type="text"
          id="channel-input"
          placeholder="request or web_message"
        />
        <label for="message-payload">Message Payload (JSON):</label>
        <textarea id="message-payload" rows="6"></textarea>
        <button id="send-button">Send Manual Event</button>
      </div>

      <div class="action-group">
        <h3>Basic Examples</h3>
        <label for="event-selector"
          >Load example into manual event fields:</label
        >
        <select id="event-selector"></select>
      </div>

      <div class="action-group advanced-actions">
        <h3>Advanced Actions</h3>
        <button id="get-menu-btn">Request Web Menu</button>
        <button id="get-sounds-btn">List Sounds</button>
        <button id="run-plugin-btn">Run RandomBot Plugin</button>
        <button id="press-ok-btn">Simulate OK Button</button>
        <button id="set-elo-btn">Set Stockfish ELO to 1500</button>
      </div>
    </div>

    <div class="column log-column">
      <h3>Logs & Messages</h3>
      <textarea id="log" readonly></textarea>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"
      integrity="sha512-8BHxHDLsOHx+flIrQ0DrZcea7MkHqRU5GbTHmbdzMRnAaoCIkZ97PqZcXJkKZckMMhqfoeaJE+DNUVuyoQsO3Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
      integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="DGTCentaurMods/opt/DGTCentaurMods/web/client/public/stockfish/stockfish.js"></script>

    <script>
      // HTML elements
      const logElement = document.getElementById('log')
      const statusElement = document.getElementById('status')
      const sendButton = document.getElementById('send-button')
      const eventSelector = document.getElementById('event-selector')
      const ipInput = document.getElementById('ip-input')
      const connectButton = document.getElementById('connect-button')
      const channelInput = document.getElementById('channel-input')
      const messagePayload = document.getElementById('message-payload')
      const evalBar = document.getElementById('eval-bar')
      const evalScore = document.getElementById('eval-score')
      const topMovesElement = document.getElementById('top-moves')

      let board = null
      let socket = null
      let engine = null
      let topLines = {}

      const eventOptions = {
        '--- System ---': null,
        'Get Last Log Events': {
          channel: 'request',
          payload: { sys: 'log_events' },
        },
        'Restart CORE Service': {
          channel: 'request',
          payload: { sys: 'restart_service' },
        },
        'Restart WEB Service': {
          channel: 'request',
          payload: { sys: 'restart_web_service' },
        },
        'Go to Homescreen': {
          channel: 'request',
          payload: { sys: 'homescreen' },
        },
        'Shutdown Centaur': {
          channel: 'request',
          payload: { sys: 'shutdown' },
        },
        '--- Board / UI ---': null,
        'Send Move (e2e4)': {
          channel: 'request',
          payload: { web_move: { source: 'e2', target: 'e4' } },
        },
        'Turn on LEDs (e2e4)': {
          channel: 'web_message',
          payload: { leds: 'e2e4' },
        },
        'Flash LEDs (d4d5)': {
          channel: 'web_message',
          payload: { flash: 'd4d5' },
        },
        'Turn off all LEDs': {
          channel: 'web_message',
          payload: { leds_off: '' },
        },
        'Simulate OK Button': {
          channel: 'request',
          payload: { web_button: 'OK' },
        },
        'Simulate Back Button': {
          channel: 'request',
          payload: { web_button: 'BACK' },
        },
        '--- Data Requests ---': null,
        'Request Web Menu': { channel: 'request', payload: { web_menu: true } },
        'Request current PGN, FEN and prev. move': {
          channel: 'request',
          payload: { fen: true, pgn: true, uci_move: true },
        },
        'List Available Sounds': {
          channel: 'request',
          payload: { data: 'sounds_settings' },
        },
        'List Previous Games': {
          channel: 'request',
          payload: { data: 'previous_games' },
        },
        'Get Moves for Game ID 1': {
          channel: 'request',
          payload: { data: 'game_moves', id: 1 },
        },
        '--- Modules / Plugins ---': null,
        'Run Lichess Module': {
          channel: 'request',
          payload: { execute: 'lichess_module.py' },
        },
        'Run 1-vs-1 Module': {
          channel: 'request',
          payload: { execute: '1vs1_module.py' },
        },
        'Run RandomBot Plugin': {
          channel: 'request',
          payload: { plugin_execute: 'RandomBot' },
        },
        'Play vs Stockfish (1400 ELO)': {
          channel: 'request',
          payload: { execute: 'uci_module.py white stockfish "1400"' },
        },
        '--- Files & Scripts ---': null,
        'Read config.ini': {
          channel: 'request',
          payload: { read: { id: 'conf', file: 'centaur' } },
        },
        'Read Stockfish UCI file': {
          channel: 'request',
          payload: { read: { id: 'uci', file: 'stockfish' } },
        },
        'Execute Live Script': {
          channel: 'request',
          payload: { live_script: 'SCREEN.home_screen("Live Script!")' },
        },
        '--- Chat ---': null,
        'Send a Chat Message': {
          channel: 'web_message',
          payload: {
            chat_message: {
              author: 'Tester',
              message: 'Hello from the tester!',
            },
          },
        },
      }

      function populateEvents() {
        eventSelector.innerHTML = ''
        const placeholder = document.createElement('option')
        placeholder.text = 'Select an example...'
        placeholder.disabled = true
        placeholder.selected = true
        eventSelector.add(placeholder)

        for (const name of Object.keys(eventOptions)) {
          const option = document.createElement('option')
          option.text = name
          option.value = name
          if (eventOptions[name] === null) {
            option.disabled = true
            option.style.fontWeight = 'bold'
            option.style.backgroundColor = '#eee'
          }
          eventSelector.add(option)
        }
      }

      function log(message) {
        logElement.value += `[${new Date().toLocaleTimeString()}] ${message}\n`
        logElement.scrollTop = logElement.scrollHeight
      }

      function sendSocketMessage(channel, payload) {
        if (!socket || !socket.connected) {
          alert('Not connected. Please connect first.')
          return
        }
        log(`↗️ SEND on '${channel}': ${JSON.stringify(payload, null, 2)}`)
        socket.emit(channel, payload)
      }

      function setupSocketListeners() {
        socket.on('connect', () => {
          statusElement.textContent = 'Status: Connected'
          statusElement.style.color = 'green'
          log(`✅ Connected to server at ${ipInput.value}.`)
          connectButton.textContent = 'Disconnect'
          sendSocketMessage('request', {
            fen: true,
            pgn: true,
            uci_move: true,
          })
        })

        socket.on('disconnect', () => {
          statusElement.textContent = 'Status: Disconnected'
          statusElement.style.color = 'red'
          log('Disconnected from the server.')
          connectButton.textContent = 'Connect'
        })

        socket.on('web_message', (data) => {
          if (data.centaur_screen && data.centaur_screen === {}) return // Ignore frequent updates
          log(`↘️ RECV on 'web_message': ${JSON.stringify(data, null, 2)}`)
          if (data.fen) {
            board.position(data.fen, false)
            analyzePosition(data.fen)
            updateTopMovesUI(data.fen)
          }
          if (data.popup) alert(`ℹ️ Server Popup: ${data.popup}`)
          if (data.update_menu)
            log(`ℹ️ Web menu received. See full object in console.`)
          if (data.sounds_settings)
            log(
              `ℹ️ Available sounds: ${Object.keys(data.sounds_settings).join(
                ', '
              )}`
            )
        })

        socket.on('request', (data) => {
          if (data.battery) return // Ignore frequent battery updates
          log(`↘️ RECV on 'request': ${JSON.stringify(data, null, 2)}`)
        })
      }

      connectButton.addEventListener('click', () => {
        if (socket && socket.connected) {
          socket.disconnect()
        } else {
          const centaurIP = ipInput.value.trim()
          if (!centaurIP) {
            alert('Please enter an IP address.')
            return
          }
          socket = io(`http://${centaurIP}`, { reconnection: false })
          setupSocketListeners()
        }
      })

      sendButton.addEventListener('click', () => {
        const channel = channelInput.value.trim()
        const payloadString = messagePayload.value
        if (!channel || !payloadString) {
          alert('Channel and Message Payload must be provided.')
          return
        }
        try {
          const payload = JSON.parse(payloadString)
          sendSocketMessage(channel, payload)
        } catch (e) {
          alert(`Invalid JSON in payload: ${e.message}`)
        }
      })

      eventSelector.addEventListener('change', (e) => {
        const eventName = e.target.value
        const eventData = eventOptions[eventName]
        if (eventData) {
          channelInput.value = eventData.channel
          messagePayload.value = JSON.stringify(eventData.payload, null, 2)
        }
      })

      function onDrop(source, target) {
        const move = { source, target }
        sendSocketMessage('request', { web_move: move })
        // The server will validate and send back a new FEN if the move is legal.
        // We return 'snapback' to wait for the server's authority.
        return 'snapback'
      }

      // Advanced Actions
      document
        .getElementById('get-menu-btn')
        .addEventListener('click', () =>
          sendSocketMessage('request', { web_menu: true })
        )
      document
        .getElementById('get-sounds-btn')
        .addEventListener('click', () =>
          sendSocketMessage('request', { data: 'sounds_settings' })
        )
      document
        .getElementById('run-plugin-btn')
        .addEventListener('click', () =>
          sendSocketMessage('request', { plugin_execute: 'RandomBot' })
        )
      document
        .getElementById('press-ok-btn')
        .addEventListener('click', () =>
          sendSocketMessage('request', { web_button: 'OK' })
        )
      document
        .getElementById('set-elo-btn')
        .addEventListener('click', async () => {
          log('Attempting to set Stockfish ELO to 1500...')
          sendSocketMessage('request', {
            write: {
              id: 'uci',
              file: 'stockfish',
              text: '[1500]\nSkill Level = 5\n',
            },
          })
        })

      // Stockfish Integration
      function initStockfish() {
        log('Initializing Stockfish...')
        try {
          engine = new Worker(
            'DGTCentaurMods/opt/DGTCentaurMods/web/client/public/stockfish/stockfish.js'
          )
          engine.onmessage = function (event) {
            const message = event.data
            //log(`SF: ${message}`); // Uncomment for full stockfish logs

            if (message.startsWith('info depth')) {
              const fen = board.fen()
              const turn = fen.split(' ')[1]

              const multipvMatch = message.match(/multipv (\d+)/)
              if (!multipvMatch) return
              const lineNum = parseInt(multipvMatch[1])

              const pvMatch = message.match(/ pv (.+)/)
              const firstMoveUCI = pvMatch ? pvMatch[1].split(' ')[0] : null

              const cpMatch = message.match(/score cp (-?\d+)/)
              if (cpMatch) {
                let score = parseInt(cpMatch[1], 10)
                if (turn === 'b') {
                  score = -score
                }
                topLines[lineNum] = {
                  score: score,
                  type: 'cp',
                  uci: firstMoveUCI,
                }
              }

              const mateMatch = message.match(/score mate (-?\d+)/)
              if (mateMatch) {
                let mateIn = parseInt(mateMatch[1], 10)
                if (turn === 'b') {
                  mateIn = -mateIn
                }
                topLines[lineNum] = {
                  score: mateIn,
                  type: 'mate',
                  uci: firstMoveUCI,
                }
              }
            }

            if (message.startsWith('bestmove')) {
              if (topLines[1]) {
                updateEvaluation(topLines[1].type, topLines[1].score)
                // updateTopMovesUI()
              }
            }
          }
          engine.postMessage('uci')
          engine.postMessage('setoption name MultiPV value 3')
          engine.postMessage('isready')
          engine.postMessage('ucinewgame')
          log('Stockfish ready.')
        } catch (e) {
          log(`Error initializing Stockfish: ${e.message}`)
        }
      }

      function analyzePosition(fen) {
        if (!engine) return
        topLines = {}
        updateTopMovesUI()
        updateEvaluation('cp', 0)
        engine.postMessage(`position fen ${fen}`)
        engine.postMessage('go depth 15')
      }

      function updateEvaluation(type, value) {
        let scoreText = ''
        let evalPercentage = 50
        const maxEval = 800

        if (type === 'cp') {
          const pawns = value / 100.0
          scoreText = `Score: ${pawns.toFixed(2)}`
          const clampedValue = Math.max(-maxEval, Math.min(maxEval, value))
          evalPercentage = 50 + (clampedValue / maxEval) * 50
        } else if (type === 'mate') {
          scoreText = `Mate in ${Math.abs(value)}`
          evalPercentage = value > 0 ? 100 : 0
        }

        evalScore.textContent = scoreText
        evalBar.style.width = `${evalPercentage}%`
      }

      function requestFenFromServer() {
        return new Promise((resolve, reject) => {
          if (!socket || !socket.connected) {
            reject(new Error('Socket not connected'))
            return
          }

          const timeout = setTimeout(() => {
            socket.off('web_message', handler)
            reject(new Error('Timeout waiting for FEN response'))
          }, 5000)

          const handler = (data) => {
            if (data.fen) {
              clearTimeout(timeout)
              socket.off('web_message', handler)
              resolve(data.fen)
            }
          }

          socket.on('web_message', handler)
          //sendSocketMessage('request', { fen: true, pgn: true })
        })
      }

      async function updateTopMovesUI(fullFen = null) {
        if (!topMovesElement) return

        if (!fullFen) {
          try {
            fullFen = await requestFenFromServer()
          } catch (error) {
            log(`ERROR: Could not get FEN from server: ${error.message}`)
            return
          }
        }

        // console.log({ fullFen, topLines, primero: topLines['1']?.uci })
        // console.log('proximo', topLines, '1' in topLines)

        const chess = new Chess(fullFen)
        let html = ''

        for (let i = 1; i <= 3; i++) {
          const line = topLines[i]
          // console.log('Line ' + i, line)
          if (!line || !line.uci) continue

          // Convertir UCI a formato que chess.js entiende
          const from = line.uci.substring(0, 2)
          const to = line.uci.substring(2, 4)
          const promotion = line.uci.length > 4 ? line.uci[4] : undefined

          // Crear objeto de movimiento para chess.js
          const moveObj = {
            from: from,
            to: to,
          }

          if (promotion) {
            moveObj.promotion = promotion
          }

          const move = chess.move(moveObj)

          let san = '--'
          if (move) {
            console.log('Move found: ' + move.san)
            san = move.san
            chess.undo() // Deshacer para mantener la posición original
          } else {
            log(
              `DEBUG: chess.js failed to parse move: ${
                line.uci
              } on FEN: ${fullFen}, Turn: ${chess.turn()}`
            )
          }

          let scoreText = ''
          if (line.type === 'cp') {
            scoreText = (line.score / 100.0).toFixed(2)
          } else {
            scoreText = `Mate in ${Math.abs(line.score)}`
          }

          html += `${i}. ${san.padEnd(7)} (${scoreText})\n`
        }
        topMovesElement.innerText = html
      }

      // --- Initialization ---
      board = Chessboard('board', {
        draggable: true,
        pieceTheme:
          'DGTCentaurMods/opt/DGTCentaurMods/web/static/chessboardjs/img/chesspieces/wikipedia/{piece}.png',
        position: 'start',
        onDrop: onDrop,
      })
      populateEvents()
      initStockfish()
      analyzePosition('start')

      const centaurIP = ipInput.value.trim()
      socket = io(`http://${centaurIP}`, { reconnection: false })
      setupSocketListeners()
    </script>
  </body>
</html>
