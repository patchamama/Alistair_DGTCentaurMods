<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DGT Centaur Socket Tester</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
      integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"
      crossorigin="anonymous"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        padding: 10px;
        gap: 20px;
      }
      .main-controls,
      .logs {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      #board {
        width: 400px;
      }
      #log {
        width: 500px;
        height: 400px;
        border: 1px solid #ccc;
        padding: 5px;
        overflow-y: scroll;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
      }
      #status {
        font-weight: bold;
      }
      .action-group,
      .connection-group {
        display: flex;
        flex-direction: column;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        gap: 5px;
      }
      .connection-group div {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      select,
      button,
      input {
        padding: 8px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="main-controls">
      <h2>DGT Centaur Socket Tester</h2>
      <div class="connection-group">
        <div>
          <label for="ip-input">Centaur IP:</label>
          <input type="text" id="ip-input" value="192.168.0.171" />
          <button id="connect-button">Connect</button>
        </div>
        <div id="status">Status: Disconnected</div>
      </div>
      <div id="board"></div>
      <p>Drag pieces to propose a move.</p>
    </div>

    <div class="logs">
      <div class="action-group">
        <h3>Send Event to Server</h3>
        <select id="event-selector" size="10"></select>
        <button id="send-button">Send Message</button>
      </div>

      <h3>Logs and Messages from Server</h3>
      <textarea id="log" readonly></textarea>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"
      integrity="sha512-8BHxHDLsOHx+flIrQ0DrZcea7MkHqRU5GbTHmbdzMRnAaoCIkZ97PqZcXJkKZckMMhqfoeaJE+DNUVuyoQsO3Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
      integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
      crossorigin="anonymous"
    ></script>

    <script>
      // Get HTML elements
      const logElement = document.getElementById('log')
      const statusElement = document.getElementById('status')
      const sendButton = document.getElementById('send-button')
      const eventSelector = document.getElementById('event-selector')
      const ipInput = document.getElementById('ip-input')
      const connectButton = document.getElementById('connect-button')

      let board = null
      let socket = null

      // Define the list of testable events
      const eventOptions = {
        '--- System ---': { sys: 'log_events' },
        'Restart Main Service': { sys: 'restart_service' },
        'Restart Web Service': { sys: 'restart_web_service' },
        'Shutdown Centaur': { sys: 'shutdown' },
        '--- Files ---': { read: { id: 'plugin', file: 'HandAndBrain' } },
        'Read config.ini': { read: { id: 'conf', file: 'centaur' } },
        '--- Database ---': { data: 'previous_games' },
        'Get moves for game ID 1': { data: 'game_moves', id: 1 },
        'Delete game ID 1': { data: 'remove_game', id: 1 },
        '--- Scripts ---': { script: 'update' },
        '--- Board (via web_message) ---': { leds: 'e4' },
        'Turn on LEDs (e2e4)': { leds: 'e2e4' },
        'Turn off all LEDs': { leds_off: '' },
        'Flash on d4d5': { flash: 'd4d5' },
      }

      // Fills the dropdown with event options
      function populateEvents() {
        eventSelector.innerHTML = '' // Clear old options
        for (const [name, payload] of Object.entries(eventOptions)) {
          const option = document.createElement('option')
          option.text = name
          // The channel is determined if the name includes '--- Board'
          const channel = name.includes('--- Board') ? 'web_message' : 'request'
          option.value = JSON.stringify({ channel, payload })
          eventSelector.add(option)
        }
      }

      // Appends a message to the log text area
      function log(message) {
        logElement.value += `[${new Date().toLocaleTimeString()}] ${message}\n`
        logElement.scrollTop = logElement.scrollHeight
      }

      // Sets up all the event listeners for the socket object
      function setupSocketListeners() {
        socket.on('connect', () => {
          statusElement.textContent = 'Status: Connected'
          statusElement.style.color = 'green'
          log(`Connected to server at ${ipInput.value}.`)
          connectButton.textContent = 'Disconnect'
          socket.emit('request', {
            fen: true,
            pgn: true,
            uci_move: true,
            web_menu: true,
          })
        })

        socket.on('disconnect', () => {
          statusElement.textContent = 'Status: Disconnected'
          statusElement.style.color = 'red'
          log('Disconnected from the server.')
          connectButton.textContent = 'Connect'
        })

        // Listener for the main message channel from the server
        socket.on('web_message', (data) => {
          log(
            `Message received on 'web_message': ${JSON.stringify(
              data,
              null,
              2
            )}`
          )
          if (data.fen) board.position(data.fen, false) // Update board position
          if (data.log_events)
            log(`--- SYSTEM LOGS ---
                ${data.log_events}
                --- END LOGS ---`)
          if (data.popup) alert(`Server Popup: ${data.popup}`)
          if (data.editor)
            log(`--- FILE CONTENT: ${data.editor.file} ---
                ${data.editor.text}
                --- END FILE ---`)
        })

        // Listener for the request channel (less common for server-to-client)
        socket.on('request', (data) => {
          log(`Message received on 'request': ${JSON.stringify(data, null, 2)}`)
        })
      }

      // Handles the connect/disconnect button click
      connectButton.addEventListener('click', () => {
        if (socket && socket.connected) {
          socket.disconnect()
        } else {
          const centaurIP = ipInput.value.trim()
          if (!centaurIP) {
            alert('Please enter an IP address.')
            return
          }
          // Connect to the server using the provided IP
          socket = io(`http://${centaurIP}`, { reconnection: false })
          setupSocketListeners()
        }
      })

      // Handles the send message button click
      sendButton.addEventListener('click', () => {
        if (!socket || !socket.connected) {
          alert('Not connected. Please connect first.')
          return
        }
        try {
          const selected = JSON.parse(eventSelector.value)
          log(
            `Sending on channel '${selected.channel}': ${JSON.stringify(
              selected.payload
            )}`
          )
          socket.emit(selected.channel, selected.payload)
        } catch (e) {
          log(`Error sending message: ${e.message}`)
          alert('Please select a valid option from the list.')
        }
      })

      // Callback for when a piece is dropped on the board
      function onDrop(source, target) {
        if (!socket || !socket.connected) {
          alert('You must be connected to send moves.')
          return 'snapback' // Revert the move
        }
        // When a move is made, send the new board position (FEN) to the server
        const fen_msg = { fen: board.fen() }
        log(`Sending new FEN on 'web_message': ${fen_msg.fen}`)
        socket.emit('web_message', fen_msg)
      }

      // --- Initialization ---
      board = Chessboard('board', {
        draggable: true,
        pieceTheme:
          'DGTCentaurMods/opt/DGTCentaurMods/web/static/chessboardjs/img/chesspieces/wikipedia/{piece}.png',
        position: 'start',
        onDrop: onDrop,
      })
      populateEvents()
    </script>
  </body>
</html>
